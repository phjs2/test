<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÏóÖÎπÑÌä∏ SOL/KRW ÏãúÏÑ∏ Î∂ÑÏÑù</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f2f2f2;
    }

    .container {
      max-width: 720px;
      margin: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 1.5rem;
    }

    h2 {
      text-align: center;
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 1rem;
      line-height: 1.6;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h2>üìä ÏóÖÎπÑÌä∏ SOL/KRW ÏãúÏÑ∏ Î∂ÑÏÑù (1ÏùºÎ¥â)</h2>
    
    <canvas id="priceChart" style="max-width: 100%; height: 400px;"></canvas>
    <pre id="output">Ï°∞Ìöå Ï§ë...</pre>

  </div>

  <script>
    async function fetchData() {
      const output = document.getElementById('output');
      output.textContent = 'Ï°∞Ìöå Ï§ë...';

      try {
        const market = 'KRW-SOL';
        const now = new Date().toLocaleString();

        const res = await fetch(`https://api.upbit.com/v1/candles/days?market=${market}&count=200`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const candles = await res.json();
        const closes = candles.map(c => c.trade_price).reverse();
        const volumes = candles.map(c => c.candle_acc_trade_volume).reverse();

        const sma = (arr, len) => {
          const out = [];
          for (let i = len - 1; i < arr.length; i++) {
            const slice = arr.slice(i - len + 1, i + 1);
            out.push(slice.reduce((a, b) => a + b, 0) / len);
          }
          return out;
        };

        const EMA = (data, period) => {
          const k = 2 / (period + 1);
          const ema = [data[0]];
          for (let i = 1; i < data.length; i++) {
            ema.push(data[i] * k + ema[i - 1] * (1 - k));
          }
          return ema;
        };

        const rsiPeriod = 14;
        const rsiValues = [];
        let gainSum = 0, lossSum = 0;

        for (let i = 1; i <= rsiPeriod; i++) {
          const diff = closes[i] - closes[i - 1];
          if (diff >= 0) gainSum += diff;
          else lossSum -= diff;
        }

        let avgGain = gainSum / rsiPeriod;
        let avgLoss = lossSum / rsiPeriod;
        rsiValues.push(100 - (100 / (1 + avgGain / avgLoss)));

        for (let i = rsiPeriod + 1; i < closes.length; i++) {
          const diff = closes[i] - closes[i - 1];
          const gain = diff > 0 ? diff : 0;
          const loss = diff < 0 ? -diff : 0;

          avgGain = (avgGain * (rsiPeriod - 1) + gain) / rsiPeriod;
          avgLoss = (avgLoss * (rsiPeriod - 1) + loss) / rsiPeriod;

          const rs = avgLoss === 0 ? 100 : avgGain / avgLoss;
          rsiValues.push(100 - (100 / (1 + rs)));
        }

        const rsiSignalArr = EMA(rsiValues, 9);
        const latestRSI = rsiValues.at(-1);
        const latestSignal = rsiSignalArr.at(-1);

        const ema12 = EMA(closes, 12);
        const ema26 = EMA(closes, 26);
        const macdLine = ema12.map((val, i) => val - ema26[i]);
        const signalLine = EMA(macdLine.slice(ema26.length - macdLine.length), 9);
        const latestMACD = macdLine.at(-1);
        const latestMACDSignal = signalLine.at(-1);
        const cross = latestMACD > latestMACDSignal ? 'Í≥®Îì†ÌÅ¨Î°úÏä§' : 'Îç∞ÎìúÌÅ¨Î°úÏä§';

        const ma5 = sma(closes, 5).at(-1).toFixed(0);
        const ma20 = sma(closes, 20).at(-1).toFixed(0);
        const ma60 = sma(closes, 60).at(-1).toFixed(0);
        const ma120 = sma(closes, 120).at(-1).toFixed(0);
        const ma200 = sma(closes, 200).at(-1).toFixed(0);

        const volume = candles[0].candle_acc_trade_volume.toFixed(2);

        const currentPrice = closes.at(-1).toLocaleString();

        const result = `
üìÖ ÎÇ†Ïßú: ${now}
üìä Ï∞®Ìä∏: ÏóÖÎπÑÌä∏ SOL/KRW / 1ÏùºÎ¥â
üí∞ ÌòÑÏû¨Í∞Ä: ${currentPrice} KRW
üìà Ïù¥ÎèôÌèâÍ∑†ÏÑ†:
- 5ÏùºÏÑ†: ${ma5}
- 20ÏùºÏÑ†: ${ma20}
- 60ÏùºÏÑ†: ${ma60}
- 120ÏùºÏÑ†: ${ma120}
- 200ÏùºÏÑ†: ${ma200}

üìâ RSI: ${latestRSI.toFixed(2)} / ÏãúÍ∑∏ÎÑê: ${latestSignal.toFixed(2)}
üìâ MACD: ${latestMACD.toFixed(2)} / ÏãúÍ∑∏ÎÑê: ${latestMACDSignal.toFixed(2)} ‚Üí ${cross}
üìä Í±∞ÎûòÎüâ: ${volume} SOL
        `;
        output.textContent = result;

      // üìä Ï∞®Ìä∏ Í∑∏Î¶¨Í∏∞
      const dataMA60 = sma(closes, 60).slice(-60);
      const dataMA120 = sma(closes, 120).slice(-60);
      const dataMA200 = sma(closes, 200).slice(-60);
      const ctx = document.getElementById('priceChart').getContext('2d');
      const labels = candles.map(c => c.candle_date_time_kst.slice(0, 10)).reverse().slice(-60);
      const dataClose = closes.slice(-60);
      const dataMA5 = sma(closes, 5).slice(-60);
      const dataMA20 = sma(closes, 20).slice(-60);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: '60ÏùºÏÑ†',
              data: dataMA60,
              borderColor: 'purple',
              borderWidth: 1,
              borderDash: [5, 5],
              tension: 0.2,
            },
            {
              label: '120ÏùºÏÑ†',
              data: dataMA120,
              borderColor: 'brown',
              borderWidth: 1,
              borderDash: [5, 5],
              tension: 0.2,
            },
            {
              label: '200ÏùºÏÑ†',
              data: dataMA200,
              borderColor: 'gray',
              borderWidth: 1,
              borderDash: [5, 5],
              tension: 0.2,
            },
            {
              label: 'Ï¢ÖÍ∞Ä',
              data: dataClose,
              borderColor: 'blue',
              borderWidth: 1,
              tension: 0.2,
            },
            {
              label: '5ÏùºÏÑ†',
              data: dataMA5,
              borderColor: 'green',
              borderWidth: 1,
              borderDash: [5, 5],
              tension: 0.2,
            },
            {
              label: '20ÏùºÏÑ†',
              data: dataMA20,
              borderColor: 'orange',
              borderWidth: 1,
              borderDash: [5, 5],
              tension: 0.2,
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'SOL/KRW Ï¢ÖÍ∞Ä Î∞è Ïù¥ÎèôÌèâÍ∑†ÏÑ†' }
          },
          scales: {
            x: {
              ticks: { maxTicksLimit: 10 }
            }
          }
        }
      });


      } catch (err) {
        output.textContent = `üö® Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå Ïã§Ìå®: ${err.message}`;
        console.error('Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', err);
      }
    }

    fetchData();
  </script>
</body>
</html>
